<template>
	<div class="field">
		<div class="type-label">{{ t('layouts.graph.relation') }}</div>
		<v-select v-model="relationField" :items="relationOptions" show-deselect />
	</div>
	<div class="field">
		<div class="type-label">{{ t('layouts.graph.fixed') }}</div>
		<v-checkbox v-model="fixedPositionWritable" block :label="fixedPositionWritable ? t('enabled') : t('disabled')" />
	</div>
	<div class="field">
		<div class="type-label">{{ t('layouts.graph.color') }}</div>
		<interface-select-color :value="colorWritable" width="half" @input="colorWritable = $event" />
	</div>
	<div class="field">
		<div class="type-label">{{ t('layouts.graph.size') }}</div>
		<v-input v-model="sizeWritable" :min="1" :max="20" show-thumb-label type="number" />
	</div>
	<div class="field">
		<div class="type-label">{{ t('layouts.graph.collections_options') }}</div>
		<v-list>
			<v-list-item
				v-for="item in props.collectionsForOptions"
				:key="item.collection"
				clickable
				block
				@click="openCollection = item.collection"
			>
				{{ item.name }}
			</v-list-item>
		</v-list>
	</div>

	<v-drawer
		:model-value="openCollection !== null"
		:title="t('layouts.graph.drawer_title', { collection: formatTitle(openCollection ?? '') })"
		@cancel="openCollection = null"
	>
		<div class="content">
			<v-form
				:model-value="collectionsOptions[openCollection!]"
				:fields="fields"
				@update:modelValue="updateCollectionOptions($event)"
			/>
		</div>
	</v-drawer>
</template>

<script lang="ts">
export default {
	inheritAttrs: false,
};
</script>

<script lang="ts" setup>
import { useI18n } from 'vue-i18n';
import { useSync } from '@directus/shared/composables';
import { computed, ref } from 'vue';
import { cloneDeep } from 'lodash';
import { CollectionOptions } from './types';
import { AppCollection, Collection, DeepPartial, Field } from '@directus/shared/types';
import { useFieldsStore } from '@/stores/fields';
import formatTitle from '@directus/format-title';

interface Props {
	collection: string;
	relationField: string | null;
	baseColor: string;
	baseSize: number;
	fixedPositions: boolean;
	collectionsOptions: Record<string, CollectionOptions>;
	info: Collection | null;
	collectionsForOptions: AppCollection[];
	relationOptions: Record<string, string>[];
}

const props = withDefaults(defineProps<Props>(), {
	relationField: null,
	relatedTitles: () => ({}),
});

const openCollection = ref<string | null>(null);
const fieldsStore = useFieldsStore();

const emit = defineEmits([
	'update:relationField',
	'update:baseColor',
	'update:baseSize',
	'update:collectionsOptions',
	'update:fixedPositions',
]);

const { t } = useI18n();

const relationField = useSync(props, 'relationField', emit);
const colorWritable = useSync(props, 'baseColor', emit);
const sizeWritable = useSync(props, 'baseSize', emit);
const fixedPositionWritable = useSync(props, 'fixedPositions', emit);

function updateCollectionOptions(changes: CollectionOptions) {
	const newCollectionsOptions = cloneDeep(props.collectionsOptions);
	newCollectionsOptions[openCollection.value!] = changes;
	emit('update:collectionsOptions', newCollectionsOptions);
}

const fields = computed(() => {
	const collectionInfo = props.collectionsForOptions.find((coll) => coll.collection === openCollection.value);

	if (!collectionInfo) {
		return [];
	}

	const fieldsInfo = fieldsStore.getFieldsForCollection(collectionInfo.collection);

	const numberFields = fieldsInfo
		.filter(
			(field) =>
				field.type === 'integer' || field.type === 'decimal' || field.type === 'float' || field.type === 'bigInteger'
		)
		.map(mapFields);

	const fields: DeepPartial<Field>[] = [
		{
			field: 'displayTemplate',
			name: t('layouts.graph.display_template'),
			meta: {
				interface: 'system-display-template',
				options: {
					collectionName: collectionInfo.collection,
				},
			},
			type: 'string',
		},
		{
			field: 'colorField',
			name: t('layouts.graph.color_field'),
			meta: {
				width: 'half',
				interface: 'select-dropdown',
				options: {
					choices: fieldsInfo.filter((field) => field.type === 'string').map(mapFields),
				},
			},
			type: 'string',
		},
		{
			field: 'sizeField',
			name: t('layouts.graph.size_field'),
			meta: {
				width: 'half',
				interface: 'select-dropdown',
				options: {
					choices: numberFields,
				},
			},
			type: 'string',
		},
	];

	if (props.fixedPositions) {
		fields.push({
			field: 'xField',
			name: t('layouts.graph.x_field'),
			meta: {
				width: 'half',
				interface: 'select-dropdown',
				options: {
					choices: numberFields,
				},
			},
			type: 'string',
		});
		fields.push({
			field: 'yField',
			name: t('layouts.graph.y_field'),
			meta: {
				width: 'half',
				interface: 'select-dropdown',
				options: {
					choices: numberFields,
				},
			},
			type: 'string',
		});
	}

	fields.push({
		field: 'filters',
		name: t('layouts.graph.filters'),
		meta: {
			width: 'full',
			interface: 'list',
			options: {
				template: '{{color}} - {{size}}',
				fields: [
					{
						field: 'color',
						name: t('layouts.graph.color'),
						meta: {
							width: 'half',
							interface: 'select-color',
							display: 'color',
						},
						type: 'string',
					},
					{
						field: 'size',
						name: t('layouts.graph.size'),
						meta: {
							width: 'half',
							interface: 'input',
							options: {
								min: 1,
								max: 20,
							},
						},
						type: 'integer',
					},
					{
						field: 'filter',
						name: t('layouts.graph.filter'),
						meta: {
							interface: 'system-filter',
							options: {
								collectionName: collectionInfo.collection,
							},
						},
						type: 'json',
					},
				],
			},
		},
		type: 'string',
	});

	return fields;
});

function mapFields(field: Field) {
	return {
		text: field.name,
		value: field.field,
	};
}
</script>

<style lang="scss" scoped>
@import '@/styles/mixins/form-grid';

.nested-options {
	@include form-grid;
}

.v-checkbox {
	width: 100%;

	.spacer {
		flex-grow: 1;
	}
}

.drag-handle {
	--v-icon-color: var(--foreground-subdued);

	cursor: ns-resize;

	&:hover {
		--v-icon-color: var(--foreground-normal);
	}
}

.content {
	padding: var(--content-padding);
}
</style>
